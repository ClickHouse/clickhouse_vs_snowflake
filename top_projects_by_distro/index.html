<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ClickHouse vs Snowflake - Top projects by distro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="data:image/gif;base64,R0lGODlhIAAgAOMPAHMUEmkyHOcbF8UvJts/E3BeOih1YziiQmebLt2AFjeyQKqZKNWPjLybfPfcDP///yH5BAEKAA8ALAAAAAAgACAAAATg8MlJ6ws26z0EGcQmZgAhnN6oPg0wDA0zrGMTAADDxEJCZ4Gba8c4hX4Uw+XWeYGOyMdhgkuYrAToqIBQHBCIKQ6wcJhPyINarUBcyuYE+ndQeOsKuNlxmv3CdnZfew5yAlEPC12BhFhZiBJ2CI1GkBMHeoV9PpYPhIUDBqIFnZ8EBaKplqYMqaqIewl8A6iupFF7C1YCoaJqq4UOWQIBBmtTuIQmWWxekJQeYWuWcFYPfl+dLAELOxML2hIYDeEWt7flEufknTZB7+8NBeyINxjqDwU4QYg26BTu6KVTEQEAOw==">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">

    <style>
        :root {
            --color: black;
            --title-color: black;
            --background-color: white;

            --link-color: #08F;
            --link-hover-color: #F40;

            --selector-text-color: black;
            --selector-active-text-color: black;
            --selector-background-color: #EEE;
            --selector-active-background-color: #FFCB80;
            --selector-hover-text-color: black;
            --selector-hover-background-color: #FDB;

            --summary-every-other-row-color: #F8F8F8;
            --highlight-color: #EEE;
            --bar-color: #FFCB80;

            --tooltip-text-color: white;
            --tooltip-background-color: black;

            --nothing-selected-color: #CCC;
            --shadow-color: grey;
        }

        [data-theme="dark"] {
            --color: #CCC;
            --title-color: white;
            --background-color: #04293A;

            --link-color: #8CF;
            --link-hover-color: #FFF;

            --selector-text-color: white;
            --selector-background-color: #444;
            --selector-active-text-color: white;
            --selector-active-background-color: #088;
            --selector-hover-text-color: black;
            --selector-hover-background-color: white;

            --summary-every-other-row-color: #042e41;
            --highlight-color: #064663;
            --bar-color: #088;

            --tooltip-text-color: white;
            --tooltip-background-color: #444;

            --nothing-selected-color: #666;
            --shadow-color: black;
        }

        html, body {
            color: var(--color);
            background-color: var(--background-color);
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: auto;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            padding: 1% 3% 0 3%;
        }

        h1 {
            color: var(--title-color);
        }

        table {
             border-spacing: 1px;
        }

        .stick-left {
            position: sticky;
            left: 0px;
        }

        .selectors-container {
            padding: 2rem 0 2rem 0;
            user-select: none;
        }

        .selectors-container th {
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding-top: 0.5rem;
            padding-right: 1rem;
        }

        .selector {
            display: inline-block;
            margin-left: 0.1rem;
            padding: 0.2rem 0.5rem 0.2rem 0.5rem;
            background: var(--selector-background-color);
            color: var(--selector-text-color);
            border: 0.2rem solid var(--background-color);
            border-radius: 0.5rem;
        }

        .selector-active {
            color: var(--selector-active-text-color);
            background: var(--selector-active-background-color);
        }

        a, a:visited {
            text-decoration: none;
            color: var(--link-color);
            cursor: pointer;
        }

        a:hover {
            color: var(--link-hover-color);
        }

        .selector:hover {
            color: var(--selector-hover-text-color) !important;
            background: var(--selector-background-color);
        }

        .selector-active:hover {
            background: var(--selector-hover-background-color);
        }

        #summary tr:nth-child(odd) {
            background: var(--summary-every-other-row-color);
        }

        .summary-name {
            white-space: nowrap;
            text-align: right;
            padding-right: 1rem;
        }

        .summary-bar-cell {
            width: 100%;
        }

        .summary-bar {
            height: 1rem;
            background: var(--bar-color);
            border-radius: 0 0.2rem 0.2rem 0;
        }

        .summary-number {
            font-family: monospace;
            text-align: right;
            padding-left: 1rem;
            white-space: nowrap;
        }

        th {
            padding-bottom: 0.5rem;
        }

        .th-entry-hilite {
            background: var(--highlight-color);
            font-weight: bold;
        }

        .summary-row:hover, .summary-row-hilite {
            background: var(--highlight-color) !important;
            font-weight: bold;
        }

        #details {
            padding-bottom: 1rem;
        }

        #details th {
            vertical-align: bottom;
            white-space: pre;
        }

        #details td {
            white-space: pre;
            font-family: monospace;
            text-align: right;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }

        .shadow:hover {
            box-shadow: 0 0 1rem var(--shadow-color);
            position: relative;
        }

        #nothing-selected {
            display: none;
            font-size: 32pt;
            font-weight: bold;
            color: var(--nothing-selected-color);
        }

        .note {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            bottom: calc(100% + 0.5rem);
            visibility: hidden;
            background-color: var(--tooltip-background-color);
            color: var(--tooltip-text-color);
            box-shadow: 0 0 1rem var(--shadow-color);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            z-index: 1;
            text-align: left;
            white-space: normal;
        }

        .tooltip-result {
            left: calc(50% - 0.25rem);
            width: 20rem;
            margin-left: -10rem;
        }

        .tooltip-query {
            left: 0;
            width: 40rem;
            margin-left: -3rem;
        }

        .note:hover .tooltip {
            visibility: visible;
        }

        .tooltip::after {
            content: " ";
            position: absolute;
            top: 100%;
            border-width: 0.5rem;
            border-style: solid;
            border-color: var(--tooltip-background-color) transparent transparent transparent;
        }

        .tooltip-result::after {
            left: 50%;
            margin-left: -1rem;
        }

        .tooltip-query::after {
            left: 3rem;
            margin-left: 0.5rem;
        }

        .nowrap {
            text-wrap: none;
        }

        .themes {
            float: right;
            font-size: 200%;
            cursor: pointer;
        }

        #toggle-dark, #toggle-light {
            padding-right: 0.5rem;
            cursor: pointer;
        }

        #toggle-dark:hover, #toggle-light:hover {
            display: inline-block;
            transform: translate(1px, 1px);
            filter: brightness(125%);
        }
    </style>
    <script type="text/javascript">

const data = [
{"system":"ClickHouse","date":"2023-06-30","machine":"1024_GB","config":"parallel_replicas_date_timestamp","comment":"","tags":["Cloud"],"data_size":973216771031,"result":[[41.838,34.046,30.301],[2.726,2.381,2.111],[22.884,21.73,20.88],[0.872,0.853,0.917],[19.55,19.013,17.271],[20.683,18.186,20.232],[15.466,19.64,14.96],[13.816,14.433,12.219],[13.397,11.862,16.687],[3.809,2.348,2.636],[12.921,14.322,14.132],[2.958,2.279,2.281],[10.99,12.228,11.785],[0.697,0.723,0.73],[15.095,10.777,11.55],[1.22,1.541,1.539],[12.904,10.724,13.577],[11.605,12.471,9.818],[11.449,9.695,12.092],[14.457,11.432,11.84],[12.938,10.719,10.817],[0.744,0.794,0.637],[9.854,10.975,10.378],[1.019,1.206,1.333],[9.797,9.954,9.318],[6.605,6.05,5.715],[9.361,14.923,9.861],[1.118,1.167,1.08],[10.019,12.006,9.15],[2.738,2.423,3.014],[10.214,8.972,9.261],[2.819,2.672,2.884],[9.784,9.222,11.179],[2.339,2.381,2.193],[9.289,8.636,9.52],[7.865,2.62,2.309],[9.361,8.995,8.898],[6.812,8.642,7.946],[9.059,8.584,8.387],[1.899,2.024,1.645],[12.577,8.652,8.342],[12.698,13.369,13.028],[8.563,9.888,9.829],[5.125,4.649,5.023],[8.36,8.315,8.795],[3.698,4.018,3.963],[8.116,8.546,8.262],[5.926,6.007,5.705],[8.194,8.61,9.251],[8.153,8.382,8.231]],"source":"top_projects_by_distro/results/clickhouse_1024_GB_parallel_replicas_date_timestamp.json"}
,{"system":"ClickHouse","date":"2023-06-28","machine":"720_GB","config":"default","comment":"","tags":["Cloud"],"data_size":991638026556,"result":[[68.386,72.581,49.849],[199.481,133.843,8.778],[44.309,119.244,43.982],[101.935,48.469,80.982],[41.858,42.511,48.81],[88.49,48.232,48.469],[40.116,39.803,43.525],[125.7,48.586,46.219],[37.709,42.517,42.731],[80.139,12.029,11.968],[41.435,42.755,40.825],[28.398,10.884,38.599],[42.547,42.511,41.147],[47.809,9.884,5.89],[37.898,38.201,37.571],[38.137,9.394,10.689],[41.161,41.292,40.372],[71.742,116.296,45.354],[40.313,40.216,36.71],[72.743,73.705,72.78],[39.524,36.804,41.34],[5.567,7.136,5.753],[39.356,36.854,37.129],[6.467,6.211,6.598],[40.585,41.744,38.706],[28.396,29.726,28.64],[36.923,38.756,41.236],[7.22,22.106,7.63],[36.553,40.527,36.57],[17.083,16.187,16.069],[36.171,37.525,36.235],[15.945,15.654,17.96],[36.488,36.195,38.939],[15.195,16.203,14.937],[41.366,36.804,36.791],[24.119,11.772,23.515],[41.019,36.603,40.402],[45.068,36.246,36.193],[38.457,40.011,38.128],[11.115,11.205,12.533],[37.796,37.748,38.474],[68.402,61.73,57.268],[41.053,38.606,38.095],[30.788,30.437,30.941],[41.972,42.542,37.099],[26.022,27.933,23.412],[40.867,39.799,39.492],[37.275,37.117,35.312],[37.354,37.702,38.248],[44.879,49.029,45.29]],"source":"top_projects_by_distro/results/clickhouse_720_GB_default.json"}
,{"system":"ClickHouse","date":"2023-06-28","machine":"720_GB","config":"parallel_replicas","comment":"","tags":["Cloud"],"data_size":991638026556,"result":[[55.29,29.505,43.151],[29.962,18.475,14.595],[23.428,20.281,16.729],[15.594,11.805,10.918],[15.912,15.686,20.365],[41.046,29.119,19.006],[14.398,16.629,14.708],[17.326,18.6,17.154],[14.133,13.769,13.613],[10.081,8.378,8.017],[13.742,13.756,13.802],[7.655,6.353,8.73],[13.711,13.649,13.68],[5.584,5.812,5.274],[13.655,13.661,13.665],[4.988,3.558,5.105],[13.835,15.418,14.417],[20.886,19.721,18.609],[13.581,13.49,13.562],[28.48,22.78,20.264],[13.313,13.335,13.266],[3.668,3.57,3.171],[13.223,13.482,13.531],[4.845,3.421,4.273],[13.335,13.394,13.515],[11.475,11.502,10.868],[13.431,13.498,13.301],[5.145,3.934,4.117],[13.689,13.324,13.452],[5.762,5.692,5.545],[13.271,13.303,13.208],[6.118,5.911,6.176],[13.148,14.223,14.225],[6.287,6.231,6.082],[14.365,14.671,13.42],[6.216,4.862,6.461],[13.805,13.378,13.381],[13.332,12.981,12.793],[13.108,13.485,13.144],[4.954,4.818,4.276],[13.542,13.472,13.354],[21.294,20.253,20.111],[13.539,13.239,13.274],[10.08,10.318,9.995],[13.166,13.145,13.293],[8.754,8.586,8.536],[13.131,13.123,13.243],[12.203,12.166,12.131],[13.269,13.307,13.294],[16.142,15.846,15.844]],"source":"top_projects_by_distro/results/clickhouse_720_GB_parallel_replicas.json"}
,{"system":"ClickHouse","date":"2023-06-30","machine":"720_GB","config":"parallel_replicas_date_timestamp","comment":"","tags":["Cloud"],"data_size":991638026556,"result":[[103.901,39.576,75.581],[5.519,2.661,3.788],[36.563,27.589,24.794],[1.401,0.472,0.504],[41.055,20.848,28.111],[31.644,17.948,24.683],[18.102,18.003,18.764],[18.872,16.004,16.763],[17.998,17.118,17.199],[2.815,2.716,2.805],[17.243,17.214,17.166],[3.478,3.987,3.594],[17.138,17.118,17.17],[0.65,0.514,0.418],[16.947,16.973,16.892],[1.079,0.878,0.685],[16.419,16.598,19.242],[15.396,15.616,14.829],[17.608,16.512,16.509],[19.556,18.734,16.782],[17.667,16.48,16.816],[0.433,0.469,0.435],[16.127,16.462,16.313],[1.088,1.153,1.052],[16.531,16.631,16.567],[8.399,8.431,8.602],[16.787,16.467,16.482],[1.16,1.117,0.998],[16.64,16.949,16.697],[3.463,3.445,3.388],[16.77,17.078,16.672],[3.901,3.802,3.416],[16.436,16.331,16.212],[3.377,3.335,3.343],[16.477,16.612,16.953],[4.825,3.509,2.976],[17.092,16.523,16.638],[10.796,11.324,10.963],[17.86,18.007,18.385],[2.647,3.646,2.628],[17.561,16.489,16.382],[18.327,18.418,18.653],[16.159,16.18,16.46],[7.915,7.928,7.938],[16.456,16.38,16.383],[6.602,6.628,6.603],[17.664,17.628,17.99],[11.18,11.5,10.803],[16.391,16.51,16.437],[14.256,14.517,14.104]],"source":"top_projects_by_distro/results/clickhouse_720_GB_parallel_replicas_date_timestamp.json"}
,{"system":"ClickHouse","date":"2023-06-29","machine":"960_GB","config":"parallel_replicas","comment":"","tags":["Cloud"],"data_size":974139632294,"result":[[39.752,34.003,25.362],[15.804,17.046,12.036],[24.703,20.273,15.098],[11.386,9.804,8.748],[16.977,14.485,14.379],[31.94,30.581,24.427],[15.801,15.299,14.321],[24.04,18.41,17.79],[11.304,12.289,11.456],[8.642,7.371,7.693],[10.481,11.602,10.597],[8.835,7.946,5.646],[9.693,11.153,9.417],[6.573,5.423,4.951],[9.501,9.5,9.401],[5.347,4.843,4.789],[9.27,9.01,8.352],[15.271,14.788,15.786],[9.009,9.099,8.572],[17.147,16.87,15.925],[8.691,8.381,8.478],[5.305,3.298,3.444],[8.477,8.117,8.44],[3.627,3.755,3.692],[8.677,8.355,8.47],[12.463,7.997,7.781],[8.02,8.19,8.195],[4.292,4.21,3.745],[8.089,8.346,8.259],[4.674,5.125,4.239],[8.056,7.91,8.272],[4.778,5.287,6.393],[8.188,8.125,8.406],[6.451,5.793,8.278],[13.514,12.61,11.709],[7.495,6.351,6.3],[10.426,9.729,9.041],[12.861,11.095,10.725],[8.708,8.592,8.283],[5.403,4.362,4.266],[8.382,8.31,8.479],[15.9,14.73,15.42],[8.166,8.517,8.088],[7.884,7.3,6.632],[8.107,8.179,8.172],[5.983,5.877,5.896],[7.881,8.129,8.096],[8.278,8.192,7.498],[7.864,8.02,8.103],[10.316,10.475,10.532]],"source":"top_projects_by_distro/results/clickhouse_960_GB_parallel_replicas.json"}
,{"system":"ClickHouse","date":"2023-06-30","machine":"960_GB","config":"parallel_replicas_date_timestamp","comment":"","tags":["Cloud"],"data_size":961365748785,"result":[[71.091,37.222,36.524],[6.133,5.094,3.752],[20.727,28.131,24.889],[3.491,1.597,1.823],[20.382,38.031,28.776],[25.443,21.237,19.253],[14.573,17.131,20.893],[12.232,11.672,10.817],[14.964,17.635,17.713],[2.675,2.435,3.411],[15.226,13.689,15.456],[3.337,4.271,2.547],[13.411,12.945,13.802],[1.268,1.041,1.383],[12.165,13.105,16.671],[1.555,2.389,0.851],[12.506,12.57,12.313],[13.165,12.384,10.592],[14.012,12.776,12.379],[14.462,12.283,12.951],[11.135,11.207,12.296],[0.866,1.545,1.194],[11.36,12.159,11.983],[1.779,1.237,1.413],[10.448,11.958,10.466],[6.599,7.423,6.739],[11.644,12.254,11.555],[1.255,0.842,1.646],[12.843,11.152,11.099],[3.563,3.53,3.443],[8.996,12.815,11.528],[2.782,2.643,2.68],[11.431,11.35,10.911],[2.916,2.306,3.128],[12.008,10.839,11.419],[3.674,3.042,3.046],[11.013,11.883,11.107],[8.965,8.778,9.366],[11.863,11.143,11.338],[1.876,1.846,1.916],[10.85,11.596,11.243],[13.343,13.594,13.279],[11.107,11.344,11.987],[5.779,6.45,5.866],[11.773,11.023,11.094],[5.046,4.246,4.139],[9.402,9.192,9.251],[5.887,5.899,6.766],[9.214,9.251,9.342],[8.255,7.985,8.034]],"source":"top_projects_by_distro/results/clickhouse_960_GB_parallel_replicas_date_timestamp.json"}
,{"system":"Snowflake","date":"2023-06-28","machine":"2XLARGE","config":"date_project_cluster","comment":"","tags":["Cloud"],"data_size":1467343154176,"result":[[35.032,25.916,26.033],[3.047,3.031,2.628],[20.103,20.155,20.543],[1.283,1.129,1.305],[19.653,19.257,19.369],[12.849,12.508,12.686],[15.053,15.103,14.937],[10.131,9.744,9.953],[14.19,14.316,14.399],[2.796,2.653,2.687],[14.238,13.958,14.343],[2.647,2.009,1.805],[13.229,13.624,13.167],[1.21,1.117,1.117],[12.844,12.69,13.429],[1.397,1.29,1.091],[11.803,12.156,11.757],[8.838,9.145,8.918],[12.482,12.265,12.545],[9.882,9.848,9.733],[11.966,12.516,11.879],[0.984,0.841,0.879],[12.208,12.772,12.614],[1.305,1.178,1.14],[11.556,11.328,11.39],[5.252,5.634,5.178],[11.287,11.425,11.068],[1.536,1.565,1.317],[11.179,11.357,11.041],[3.115,2.684,2.256],[9.645,9.74,9.516],[2.603,2.402,2.489],[10.786,10.786,10.975],[2.813,2.727,2.495],[10.919,10.87,11.007],[2.179,2.151,2.157],[10.314,10.403,10.28],[5.974,6.118,5.84],[9.203,9.693,9.359],[2.056,2.1,1.995],[11.658,11.659,11.951],[10.147,10.26,10.588],[10.435,10.235,10.39],[4.405,4.403,4.374],[10.057,10.134,9.947],[4.248,3.894,4.064],[9.569,9.481,9.451],[5.396,5.054,5.213],[10.302,10.131,9.903],[7.231,7.138,7.54]],"source":"top_projects_by_distro/results/snowflake_2XLARGE_date_project_cluster.json"}
,{"system":"Snowflake","date":"2023-07-01","machine":"2XLARGE","config":"date_timestamp_cluster","comment":"","tags":["Cloud"],"data_size":1869052114432,"result":[[32.684,23.62,22.527],[3.328,3.707,1.978],[16.233,15.87,16.051],[1.09,0.888,1.895],[14.822,14.957,14.691],[9.818,9.904,9.536],[10.365,10.391,10.362],[6.759,6.814,6.765],[9.919,9.76,9.858],[2.033,2.048,1.811],[9.816,9.581,9.577],[1.775,1.593,1.713],[8.938,9.276,8.986],[2.643,0.594,0.589],[8.522,8.522,8.669],[0.942,1.012,0.689],[8.006,7.942,8.16],[5.87,5.758,5.627],[7.726,7.572,7.625],[6.533,6.367,6.36],[7.467,7.515,7.502],[0.594,0.606,0.51],[8.482,8.486,8.698],[1.265,1.028,1.03],[7.752,7.593,7.472],[3.454,3.674,3.464],[7.447,7.794,7.756],[1.19,0.799,1.191],[7.341,7.111,7.56],[2.097,1.891,1.725],[7.93,7.914,7.632],[2.166,2.062,1.593],[8.494,8.234,8.468],[2.014,2.126,1.749],[7.509,7.727,7.347],[2.097,1.868,1.622],[7.414,7.563,7.257],[4.386,4.249,4.207],[7.162,6.911,6.88],[1.622,1.214,1.282],[8.363,8.429,8.447],[7.694,7.69,7.416],[7.103,6.896,6.981],[3.191,3.105,3.406],[6.776,6.508,6.457],[2.633,2.296,2.9],[6.298,6.501,6.617],[3.433,3.731,3.512],[6.801,6.744,6.807],[5.001,5.064,5.169]],"source":"top_projects_by_distro/results/snowflake_2XLARGE_date_timestamp_cluster.json"}
]; // end of data
const queries = [
"SELECT project, count() as c FROM pypi WHERE distro.name = 'Ubuntu' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Ubuntu' AND date >= '2023-06-23'::Date - toIntervalDay(67) AND date <= '2023-06-23'::Date - toIntervalDay(62) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(67) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(62) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Debian GNU/Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Debian GNU/Linux' AND date >= '2023-06-23'::Date - toIntervalDay(11) AND date <= '2023-06-23'::Date - toIntervalDay(10) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(11) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(10) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Amazon Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Amazon Linux' AND date >= '2023-06-23'::Date - toIntervalDay(63) AND date <= '2023-06-23'::Date - toIntervalDay(8) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(63) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(8) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'CentOS Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'CentOS Linux' AND date >= '2023-06-23'::Date - toIntervalDay(65) AND date <= '2023-06-23'::Date - toIntervalDay(10) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(65) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(10) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Amazon Linux AMI' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Amazon Linux AMI' AND date >= '2023-06-23'::Date - toIntervalDay(46) AND date <= '2023-06-23'::Date - toIntervalDay(36) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(46) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(36) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Alpine Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Alpine Linux' AND date >= '2023-06-23'::Date - toIntervalDay(7) AND date <= '2023-06-23'::Date - toIntervalDay(0) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(7) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(0) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'macOS' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'macOS' AND date >= '2023-06-23'::Date - toIntervalDay(22) AND date <= '2023-06-23'::Date - toIntervalDay(21) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(22) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(21) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Red Hat Enterprise Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Red Hat Enterprise Linux' AND date >= '2023-06-23'::Date - toIntervalDay(2) AND date <= '2023-06-23'::Date - toIntervalDay(0) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(2) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(0) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'CentOS Stream' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'CentOS Stream' AND date >= '2023-06-23'::Date - toIntervalDay(67) AND date <= '2023-06-23'::Date - toIntervalDay(6) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(67) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(6) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Red Hat Enterprise Linux Server' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Red Hat Enterprise Linux Server' AND date >= '2023-06-23'::Date - toIntervalDay(78) AND date <= '2023-06-23'::Date - toIntervalDay(7) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(78) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(7) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Rocky Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Rocky Linux' AND date >= '2023-06-23'::Date - toIntervalDay(2) AND date <= '2023-06-23'::Date - toIntervalDay(1) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(2) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(1) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Fedora Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Fedora Linux' AND date >= '2023-06-23'::Date - toIntervalDay(3) AND date <= '2023-06-23'::Date - toIntervalDay(0) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(3) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(0) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Oracle Linux Server' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Oracle Linux Server' AND date >= '2023-06-23'::Date - toIntervalDay(57) AND date <= '2023-06-23'::Date - toIntervalDay(21) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(57) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(21) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'SLES' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'SLES' AND date >= '2023-06-23'::Date - toIntervalDay(6) AND date <= '2023-06-23'::Date - toIntervalDay(2) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(6) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(2) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'AlmaLinux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'AlmaLinux' AND date >= '2023-06-23'::Date - toIntervalDay(43) AND date <= '2023-06-23'::Date - toIntervalDay(29) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(43) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(29) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Raspbian GNU/Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Raspbian GNU/Linux' AND date >= '2023-06-23'::Date - toIntervalDay(72) AND date <= '2023-06-23'::Date - toIntervalDay(58) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(72) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(58) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'CentOS' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'CentOS' AND date >= '2023-06-23'::Date - toIntervalDay(29) AND date <= '2023-06-23'::Date - toIntervalDay(15) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(29) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(15) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Arch Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Arch Linux' AND date >= '2023-06-23'::Date - toIntervalDay(87) AND date <= '2023-06-23'::Date - toIntervalDay(77) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(87) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(77) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Kali GNU/Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Kali GNU/Linux' AND date >= '2023-06-23'::Date - toIntervalDay(79) AND date <= '2023-06-23'::Date - toIntervalDay(32) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(79) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(32) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'OS X' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'OS X' AND date >= '2023-06-23'::Date - toIntervalDay(18) AND date <= '2023-06-23'::Date - toIntervalDay(9) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(18) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(9) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Fedora' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Fedora' AND date >= '2023-06-23'::Date - toIntervalDay(81) AND date <= '2023-06-23'::Date - toIntervalDay(2) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(81) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(2) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Linux Mint' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Linux Mint' AND date >= '2023-06-23'::Date - toIntervalDay(69) AND date <= '2023-06-23'::Date - toIntervalDay(35) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(69) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(35) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'openSUSE Leap' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'openSUSE Leap' AND date >= '2023-06-23'::Date - toIntervalDay(56) AND date <= '2023-06-23'::Date - toIntervalDay(28) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(56) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(28) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Common Base Linux Mariner' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Common Base Linux Mariner' AND date >= '2023-06-23'::Date - toIntervalDay(68) AND date <= '2023-06-23'::Date - toIntervalDay(24) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(68) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(24) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Manjaro Linux' AND (date >= '2023-06-23'::Date - toIntervalDay(90)) GROUP BY project ORDER BY c DESC LIMIT 10"
,"SELECT project, count() as c FROM pypi WHERE distro.name = 'Manjaro Linux' AND date >= '2023-06-23'::Date - toIntervalDay(64) AND date <= '2023-06-23'::Date - toIntervalDay(3) AND timestamp >= '2023-06-23 08:33:59'::DateTime - toIntervalDay(64) AND timestamp <= '2023-06-23 08:33:59'::DateTime - toIntervalDay(3) GROUP BY project ORDER BY c DESC LIMIT 10"
]; // end of queries

    </script>
</head>
<body>

<div class="header stick-left">
    <span class="nowrap themes"><span id="toggle-dark">🌚</span><span id="toggle-light">🌞</span></span>
    <h1>ClickHouse vs Snowflake - Top projects by distro</h1>
    <a href="https://github.com/ClickHouse/clickhouse_vs_snowflake/">Methodology</a> | <a href="https://github.com/ClickHouse/clickhouse_vs_snowflake/">Reproduce and Validate the Results</a> | <a href="https://github.com/ClickHouse/clickhouse_vs_snowflake/">Add a System</a> | <a href="https://github.com/ClickHouse/clickhouse_vs_snowflake/">Report Mistake</a>
</div>

<table class="selectors-container stick-left">
    <tr>
        <th>System: </th>
        <td id="selectors_system">
            <a id="select-all-systems" class="selector selector-active">All</a>
        </td>
    </tr>
    <tr>
        <th>Type: </th>
        <td id="selectors_type">
            <a id="select-all-types" class="selector selector-active">All</a>
        </td>
    </tr>
    <tr>
        <th>Machine: </th>
        <td id="selectors_machine">
            <a id="select-all-machines" class="selector selector-active">All</a>
        </td>
    </tr>
    <tr>
        <th>Configuration: </th>
        <td id="selectors_config">
            <a id="select-all-configs" class="selector selector-active">All</a>
        </td>
    </tr>
    <tr>
        <th>Metric: </th>
        <td id="selectors_run">
            <a class="selector" id="selector-metric-cold">Cold Run</a>
            <a class="selector" id="selector-metric-hot">Hot Run</a>
            <a class="selector" id="selector-metric-size">Storage Size</a>
        </td>
    </tr>
</table>

<table class="stick-left comparison">
    <thead>
        <tr>
            <th class="summary-name">
                System &amp; Machine
            </th>
            <th colspan="2">
                Relative <span id="time-or-size">time</span> (lower is better)
            </th>
        </tr>
    </thead>
    <tbody id="summary">
    </tbody>
</table>

<div id="nothing-selected" class="stick-left">Nothing selected</div>

<div class="stick-left comparison">
    <h2>Detailed Comparison</h2>
</div>

<table id="details">
    <thead>
        <tr id="details_head">
        </tr>
    </thead>
    <tbody id="details_body">
    </tbody>
</table>

<script type="text/javascript">

const constant_time_add = 0.01;
const missing_result_penalty = 2;
const missing_result_time = 300;

let selectors = {
    "system": {},
    "type": {},
    "machine": {},
    "config": {},
    "metric": "hot",
    "queries": [],
};

let theme = 'light';

function setTheme(new_theme) {
    theme = new_theme;
    document.documentElement.setAttribute('data-theme', theme);
    window.localStorage.setItem('theme', theme);
    render();
}

document.getElementById('toggle-light').addEventListener('click', e => setTheme('light'));
document.getElementById('toggle-dark').addEventListener('click', e => setTheme('dark'));

let new_theme = window.localStorage.getItem('theme');
if (new_theme && new_theme != theme) {
    setTheme(new_theme);
}

/// Generate selectors

let systems = document.getElementById('selectors_system');
let types = document.getElementById('selectors_type');
let machines = document.getElementById('selectors_machine');
let configs = document.getElementById('selectors_config');

let unique_systems = [... new Set(data.map(elem => elem.system))];

function toggle(e, elem, selectors_map) {
    selectors_map[elem] = !selectors_map[elem];
    e.target.className = selectors_map[elem] ? 'selector selector-active' : 'selector';
    render();
    updateHistory();
}

function toggleAll(e, selectors_map) {
    const new_value = Object.keys(selectors_map).filter(k => selectors_map[k]).length * 2 < Object.keys(selectors_map).length;
    [...e.target.parentElement.querySelectorAll('a')].map(
        elem => { elem.className = new_value ? 'selector selector-active' : 'selector' });

    Object.keys(selectors_map).map(k => { selectors_map[k] = new_value });
    render();
    updateHistory();
}

unique_systems.map(elem => {
    let selector = document.createElement('a');
    selector.className = 'selector selector-active';
    selector.appendChild(document.createTextNode(elem));
    systems.appendChild(selector);
    if (!(elem in selectors.system)) { selectors.system[elem] = data.some(entry => entry.system == elem && !entry.hide); }
    selector.addEventListener('click', e => toggle(e, elem, selectors.system));

    /// Highlighting summary rows and table columns on hovering over the system selector.
    selector.addEventListener('mouseover', e => {
        [...document.querySelectorAll('.summary-row')].map(row => {
            row.className = row.dataset.system == elem ? 'summary-row summary-row-hilite' : 'summary-row' });
        [...document.querySelectorAll('.th-entry')].map(th => {
            th.className = th.dataset.system == elem ? 'th-entry th-entry-hilite' : 'th-entry' });
    });
    selector.addEventListener('mouseout', e => {
        [...document.querySelectorAll('.summary-row')].map(row => { row.className = 'summary-row' });
        [...document.querySelectorAll('.th-entry')].map(row => { row.className = 'th-entry' });
    });
});

[... new Set(data.map(elem => elem.tags).flat())].map(elem => {
    let selector = document.createElement('a');
    selector.className = 'selector selector-active';
    selector.appendChild(document.createTextNode(elem));
    types.appendChild(selector);
    if (!(elem in selectors.type)) { selectors.type[elem] = true; }
    selector.addEventListener('click', e => toggle(e, elem, selectors.type));
});

[... new Set(data.map(elem => elem.machine))].map(elem => {
    let selector = document.createElement('a');
    selector.className = 'selector selector-active';
    selector.appendChild(document.createTextNode(elem));
    machines.appendChild(selector);
    if (!(elem in selectors.machine)) { selectors.machine[elem] = true; }
    selector.addEventListener('click', e => toggle(e, elem, selectors.machine));
});

[... new Set(data.map(elem => elem.config))].sort(
    (a, b) => ((typeof(b) === 'number') - (typeof(a) === 'number')) || (a - b)).map(elem => {
    let selector = document.createElement('a');
    selector.className = 'selector selector-active';
    selector.appendChild(document.createTextNode(elem));
    configs.appendChild(selector);
    if (!(elem in selectors.config)) { selectors.config[elem] = true; }
    selector.addEventListener('click', e => toggle(e, elem, selectors.config));
});

document.getElementById('select-all-systems').addEventListener('click', e => toggleAll(e, selectors.system));
document.getElementById('select-all-types').addEventListener('click', e => toggleAll(e, selectors.type));
document.getElementById('select-all-machines').addEventListener('click', e => toggleAll(e, selectors.machine));
document.getElementById('select-all-configs').addEventListener('click', e => toggleAll(e, selectors.config));

[...document.getElementById('selectors_run').querySelectorAll('a')].map(elem => elem.addEventListener('click', e => {
    [...e.target.parentElement.querySelectorAll('a')].map(elem => { elem.className = elem == e.target ? 'selector selector-active' : 'selector' });
}));

document.getElementById('selector-metric-cold').addEventListener('click', e => { selectors.metric = 'cold'; render(); updateHistory(); });
document.getElementById('selector-metric-hot').addEventListener('click', e => { selectors.metric = 'hot'; render(); updateHistory(); });
document.getElementById('selector-metric-size').addEventListener('click', e => { selectors.metric = 'size'; render(); updateHistory(); });

selectors.queries = [...data[0].result.keys()].map(k => true);

function updateSelectors() {
    [...systems.childNodes].map(elem => { elem.className = selectors.system[elem.innerText] ? 'selector selector-active' : 'selector' });
    [...types.childNodes].map(elem => { elem.className = selectors.type[elem.innerText] ? 'selector selector-active' : 'selector' });
    [...machines.childNodes].map(elem => { elem.className = selectors.machine[elem.innerText] ? 'selector selector-active' : 'selector' });
    [...configs.childNodes].map(elem => { elem.className = selectors.config[elem.innerText] ? 'selector selector-active' : 'selector' });

    [...document.getElementById('selectors_run').querySelectorAll('a')].map(elem => {
        elem.className = elem.id == 'selector-metric-' + selectors.metric ? 'selector selector-active' : 'selector' });

    [...document.querySelectorAll('.query-checkbox')].map((elem, i) => { elem.checked = selectors.queries[i] });
}

function clearElement(elem)
{
    while (elem.firstChild) {
        elem.removeChild(elem.lastChild);
    }
}

function selectRun(timings) {
    return selectors.metric == 'cold' ? timings[0] : (timings.some(timing => timing !== null) ? Math.min(...timings.slice(1).filter(timing => timing !== null)) : null)
}

function addNote(text) {
    let note = document.createElement('sup');
    note.className = 'note';
    note.appendChild(document.createTextNode('†'));

    let tooltip = document.createElement('span');
    tooltip.className = 'tooltip tooltip-result';
    tooltip.appendChild(document.createTextNode(text));

    note.appendChild(tooltip);
    return note;
}

function renderSummary(filtered_data) {
    let table = document.getElementById('summary');
    clearElement(table);

    /// Generate summary

    /// The algorithm: for each of the queries,
    /// - if there is a result - take query duration, add 10 ms, and divide it to the corresponding value from the baseline,
    /// - if there is no result - take the worse query duration across all query runs for this system and multiply by 2.
    /// Take geometric mean across the queries.

    let summary = {};

    const num_queries = filtered_data[0].result.length;

    const baseline_data = [...filtered_data[0].result.keys()].map(query_num =>
        [...Array(5).keys()].map(run_num =>
            Math.min(...filtered_data.filter(elem => !elem.fake).map(elem => elem.result[query_num][run_num]).filter(x => x))));

    const min_data_size = Math.min(...filtered_data.map(elem => elem.data_size).filter(x => x));

    let summaries;
    if (selectors.metric == 'size') {
        summaries = filtered_data.map(elem => elem.data_size / min_data_size);
        document.getElementById('time-or-size').innerText = 'size';
    } else {
        summaries = filtered_data.map(elem => {
            const fallback_timing = missing_result_penalty * Math.max(missing_result_time, ...elem.result.map(timings => selectRun(timings)));

            let accumulator = 0;
            let used_queries = 0;

            const no_queries_selected = selectors.queries.filter(x => x).length == 0;

            for (let i = 0; i < num_queries; ++i) {
                if (no_queries_selected || selectors.queries[i]) {
                    const curr_timing = selectRun(elem.result[i]) ?? fallback_timing;
                    const baseline_timing = selectRun(baseline_data[i]);
                    const ratio = (constant_time_add + curr_timing) / (constant_time_add + baseline_timing);
                    accumulator += Math.log(ratio);
                    ++used_queries;
                }
            }

            return Math.exp(accumulator / used_queries);
        });
        document.getElementById('time-or-size').innerText = 'time';
    }

    const sorted_indices = [...summaries.keys()].sort((a, b) => summaries[a] - summaries[b]);
    const max_ratio = summaries[sorted_indices[sorted_indices.length - 1]];

    sorted_indices.map(idx => {
        const elem = filtered_data[idx];

        if (selectors.metric == 'size' && elem.data_size === null) { return; }

        let tr = document.createElement('tr');
        tr.className = 'summary-row';

        tr.dataset.system = elem.system;

        let td_name = document.createElement('td');
        td_name.className = 'summary-name';

        if (!elem.fake) {
            let link = document.createElement('a');
            link.appendChild(document.createTextNode(`${elem.system} (${Number.isInteger(elem.config) && elem.config > 1 ? elem.config + '×': ''}${elem.machine} - ${elem.config})`));
            link.href = "https://github.com/ClickHouse/clickhouse_vs_snowflake/blob/main/" + elem.source;
            td_name.appendChild(link);
        } else {
            td_name.appendChild(document.createTextNode(elem.system));
        }

        if (elem.comment) { td_name.appendChild(addNote(elem.comment)); }
        td_name.appendChild(document.createTextNode(': '));

        const ratio = summaries[idx];
        const percentage = summaries[idx] / max_ratio * 100;

        let td_number = document.createElement('td');
        td_number.className = 'summary-number';

        const text = selectors.metric == 'size' ? `${(elem.data_size / 1024 / 1024 / 1024).toFixed(2)} GiB (×${ratio.toFixed(2)})`
            : `×${ratio.toFixed(2)}`;

        td_number.appendChild(document.createTextNode(text));

        let td_bar = document.createElement('td');
        td_bar.className = 'summary-bar-cell';

        let bar = document.createElement('div');

        bar.className = `summary-bar`;
        bar.style.width = `${percentage}%`;

        td_bar.appendChild(bar);

        tr.appendChild(td_name);
        tr.appendChild(td_bar);
        tr.appendChild(td_number);
        table.appendChild(tr);
    });

    return [sorted_indices, baseline_data];
}

function colorize(elem, ratio) {
    let [r, g, b] = [0, 0, 0];

    /// ratio less than 1 - green
    /// ratio from 1 to 2 - green to yellow
    /// ratio from 2 to 10 - yellow to red
    /// ratio from 10 to 1000 to infinity - red to brown to black

    /// Note: we are using RGB space without proper gamma correction. Read more: https://www.handprint.com/HP/WCL/color1.html

    if (ratio !== null) {
        if (ratio < 1) {
            r = 232;
            g = 255;
            b = 232;
        } else if (ratio <= 1) {
            g = 255;
        } else if (ratio <= 2) {
            g = 255;
            r = (ratio - 1) * 255;
        } else if (ratio <= 10) {
            g = (10 - ratio) / 8 * 255;
            r = 255;
        } else {
            r = (1 - ((ratio - 10) / ((ratio - 10) + 1000))) * 255;
        }
    }

    if (document.documentElement.getAttribute('data-theme') == 'dark') {
        r /= 1.5;
        g /= 1.5;
        b /= 1.5;
    }

    elem.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
    if (ratio === null || ratio > 10) {
        /// This will look better on dark backgrounds
        elem.style.color = 'white';
    } else {
        elem.style.color = 'black';
    }

    /// The best result is highlighted
    if (ratio == 1) {
        elem.style.fontWeight = 'bold';
    }
}

function render() {
    let details_head = document.getElementById('details_head');
    let details_body = document.getElementById('details_body');

    clearElement(details_head);
    clearElement(details_body);

    let filtered_data = data.filter(elem =>
        selectors.system[elem.system] &&
        selectors.machine[elem.machine] &&
        selectors.config[elem.config] &&
        elem.tags.filter(type => selectors.type[type]).length > 0);

    let nothing_selected_elem = document.getElementById('nothing-selected');
    if (filtered_data.length == 0) {
        nothing_selected_elem.style.display = 'block';
        [...document.querySelectorAll('.comparison')].map(e => e.style.display = 'none');
        return;
    }
    nothing_selected_elem.style.display = 'none';
    [...document.querySelectorAll('.comparison')].map(e => e.style.display = 'block');

    if (selectors.metric == 'size') {
        filtered_data = [...filtered_data];
    }

    let [sorted_indices, baseline_data] = renderSummary(filtered_data);
    sorted_indices = sorted_indices.filter(idx => !filtered_data[idx].fake);

    /// Generate details

    /// Global checkbox
    {
        let th_checkbox = document.createElement('th');
        let checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.addEventListener('change', e => {
            [...document.querySelectorAll('.query-checkbox')].map(elem => { elem.checked = e.target.checked });
            selectors.queries.map((_, i) => { selectors.queries[i] = e.target.checked });
            renderSummary(filtered_data);
            updateHistory();
        });
        th_checkbox.appendChild(checkbox);
        details_head.appendChild(th_checkbox);
        details_head.appendChild(document.createElement('th'));
    }

    /// Table header
    sorted_indices.map(idx => {
        const elem = filtered_data[idx];
        let th = document.createElement('th');
        th.appendChild(document.createTextNode(`${elem.system}\n(${Number.isInteger(elem.config) && elem.config > 1 ? elem.config + '×': ''}${elem.machine} - \n ${elem.config})`));
        th.className = 'th-entry';
        th.dataset.system = elem.system;
        details_head.appendChild(th);
    });



    /// Data sizes
    {
        let tr = document.createElement('tr');
        tr.className = 'shadow';

        let td_title = document.createElement('td');
        td_title.colSpan = 2;
        td_title.appendChild(document.createTextNode('Data size: '));
        tr.appendChild(td_title);

        sorted_indices.map(idx => {
            const curr_size = filtered_data[idx].data_size;
            const baseline_size = Math.min(...filtered_data.map(elem => elem.data_size).filter(x => x));
            const ratio = curr_size !== null ? curr_size / baseline_size : null;

            let td = document.createElement('td');
            td.appendChild(document.createTextNode(curr_size !== null ? `${(curr_size / 1024 / 1024 / 1024).toFixed(2)} GiB (×${ratio.toFixed(2)})` : '☠'));

            colorize(td, ratio);
            tr.appendChild(td);
        });

        details_body.appendChild(tr);
    }

    /// Query runtimes
    const num_queries = filtered_data[0].result.length;

    for (let query_num = 0; query_num < num_queries; ++query_num) {
        let tr = document.createElement('tr');
        tr.className = 'shadow';

        let td_checkbox = document.createElement('td');
        let checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'query-checkbox';
        checkbox.checked = selectors.queries[query_num];
        checkbox.addEventListener('change', e => {
            selectors.queries[query_num] = e.target.checked;
            renderSummary(filtered_data);
            updateHistory();
        });
        td_checkbox.appendChild(checkbox);
        tr.appendChild(td_checkbox);

        let td_query_num = document.createElement('td');
        td_query_num.className = 'note';
        td_query_num.appendChild(document.createTextNode(`Q${query_num}. `));

        let tooltip = document.createElement('span');
        tooltip.className = 'tooltip tooltip-query';
        tooltip.appendChild(document.createTextNode(`Query ${query_num}: ${queries[query_num]}`));
        td_query_num.appendChild(tooltip);

        tr.appendChild(td_query_num);

        sorted_indices.map(idx => {
            const curr_timing = selectRun(filtered_data[idx].result[query_num]);
            const baseline_timing = selectRun(baseline_data[query_num]);
            const ratio = curr_timing !== null ? (constant_time_add + curr_timing) / (constant_time_add + baseline_timing) : null;

            let td = document.createElement('td');
            td.appendChild(document.createTextNode(curr_timing !== null ? `${curr_timing.toFixed(2)}s (×${ratio.toFixed(2)})` : '☠'));

            colorize(td, ratio);
            tr.appendChild(td);
        });

        details_body.appendChild(tr);
    }
}

function updateHistory() {
    history.pushState(selectors, '',
        window.location.pathname + (window.location.search || '') + '#' + btoa(JSON.stringify(selectors)));
}

window.onpopstate = function(event) {
    if (!event.state) { return; }
    selectors = event.state;
    render();
    updateSelectors();
};

if (window.location.hash) {
    try {
        selectors = JSON.parse(atob(window.location.hash.substring(1)));
    } catch {}
}

render();
updateSelectors();

</script>
</body>
</html>
